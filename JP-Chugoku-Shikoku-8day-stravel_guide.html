<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ›¸å¯«å±±ãƒ»å·¡ç¦®å¸– | 8æ—¥å‘¨éŠ</title>
    <style>
        /* --- è¦–è¦ºé¢¨æ ¼è¨­å®š (åœ“æ•™å¯ºãƒ»æ›¸å¯«å±±æ°›åœ) --- */
        :root {
            /* è‰²èª¿ï¼šå–è‡ªåœ“æ•™å¯ºçš„å·¨æœ¨ã€é’è‹”èˆ‡ç™½ç‰† */
            --c-bg: #f4f1ea; /* å’Œç´™ç™½ */
            --c-text: #2c2825; /* å¢¨é»‘ */
            --c-primary: #5c6e58; /* è‹”ç¶  (åœ“æ•™å¯ºæ£®æ—) */
            --c-primary-dark: #3a4a36;
            --c-accent: #a63737; /* æœ±å°ç´… (å¼·èª¿è‰²) */
            --c-wood: #8c7b6c; /* å¤æœ¨è‰² */
            --c-light: #e8e4dc;
            --c-white: #ffffff;
            --shadow: 0 4px 12px rgba(44, 40, 37, 0.08);
            --radius: 12px;
            --font-main: "Helvetica Neue", Helvetica, "PingFang TC", "Hiragino Sans GB", "Microsoft JhengHei", sans-serif;
            --font-serif: "Songti TC", "Noto Serif TC", serif; /* æ¨™é¡Œç”¨è¥¯ç·šé«” */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-main);
            background-color: var(--c-bg);
            color: var(--c-text);
            line-height: 1.6;
            padding-bottom: 80px; /* çµ¦åº•éƒ¨å°èˆªç•™ç©ºé–“ */
        }

        h1, h2, h3 { font-family: var(--font-serif); font-weight: 600; margin: 0; }

        /* --- UI å…ƒä»¶ --- */
        .container { max-width: 600px; margin: 0 auto; padding: 16px; }
        
        /* é ‚éƒ¨æ¨™é¡Œ */
        header {
            text-align: center;
            padding: 20px 0;
            background: linear-gradient(to bottom, var(--c-bg), rgba(244,241,234,0));
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(5px);
        }
        header h1 { font-size: 1.5rem; letter-spacing: 2px; color: var(--c-primary-dark); }
        header p { font-size: 0.8rem; color: var(--c-wood); letter-spacing: 1px; margin-top: 4px; }

        /* å¡ç‰‡é¢¨æ ¼ */
        .card {
            background: var(--c-white);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--c-primary);
            position: relative;
            transition: transform 0.2s;
        }
        .card.edit-mode { border-style: dashed; border-color: var(--c-wood); }

        /* æŒ‰éˆ• */
        .btn {
            background: var(--c-primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .btn-outline { background: transparent; border: 1px solid var(--c-primary); color: var(--c-primary); }
        .btn-danger { background: var(--c-accent); }
        .btn-sm { padding: 4px 10px; font-size: 0.8rem; }

        /* åº•éƒ¨å°èˆª */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--c-primary-dark);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            z-index: 999;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        .nav-item {
            color: rgba(255,255,255,0.6);
            text-align: center;
            font-size: 0.75rem;
            cursor: pointer;
            flex: 1;
        }
        .nav-item.active { color: var(--c-white); font-weight: bold; }
        .nav-icon { display: block; font-size: 1.2rem; margin-bottom: 4px; }

        /* --- é é¢åˆ‡æ›é‚è¼¯ --- */
        .view-section { display: none; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 1. è¡Œç¨‹è¡¨æ¨£å¼ --- */
        .day-header {
            background: var(--c-wood);
            color: white;
            padding: 10px 16px;
            border-radius: var(--radius);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .day-details { display: none; padding-left: 8px; border-left: 1px dashed var(--c-wood); margin-left: 10px; }
        .day-details.open { display: block; }
        
        .timeline-item {
            position: relative;
            padding-left: 20px;
            margin-bottom: 12px;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -5px;
            top: 6px;
            width: 10px;
            height: 10px;
            background: var(--c-accent);
            border-radius: 50%;
        }
        .time-badge {
            font-size: 0.75rem;
            background: var(--c-light);
            color: var(--c-text);
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 6px;
            font-weight: bold;
        }
        .drag-handle { float: right; color: #ccc; cursor: grab; }

        /* --- 2. æ¢ç´¢ (åœ°åœ–) æ¨£å¼ --- */
        #map { width: 100%; height: 50vh; border-radius: var(--radius); margin-bottom: 16px; background: #eee; }
        .category-scroll {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        .category-scroll::-webkit-scrollbar { display: none; }
        .pill-btn {
            white-space: nowrap;
            padding: 6px 14px;
            border-radius: 20px;
            background: var(--c-white);
            border: 1px solid var(--c-wood);
            color: var(--c-text);
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .pill-btn.active { background: var(--c-primary); color: white; border-color: var(--c-primary); }
        
        .sub-cats { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
        .sub-pill {
            background: var(--c-light);
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 12px;
            cursor: pointer;
        }
        
        /* çˆ¸åª½è¦–è§’å¡ç‰‡ */
        .place-card {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid var(--c-accent);
        }
        .ai-tip {
            background: #fff3cd;
            color: #856404;
            font-size: 0.8rem;
            padding: 6px;
            margin-top: 6px;
            border-radius: 4px;
            display: flex;
            align-items: flex-start;
        }
        .ai-tip::before { content: 'ğŸ’¡'; margin-right: 6px; }

        /* --- 3. è¨˜å¸³æ¨£å¼ --- */
        .expense-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .total-box { background: var(--c-wood); color: white; padding: 16px; border-radius: var(--radius); text-align: right; font-size: 1.2rem; margin-bottom: 20px; }

        /* --- å¤©æ°£ Widget --- */
        .weather-widget {
            display: flex;
            background: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%);
            color: white;
            padding: 10px;
            border-radius: var(--radius);
            margin-bottom: 16px;
            align-items: center;
            justify-content: space-around;
        }
        .weather-icon { font-size: 2rem; }
    </style>
</head>
<body>

<header>
    <h1>å±±æ²³ãƒ»å·¡ç¦®</h1>
    <p>ä¸­åœ‹å››åœ‹ Ã— åœ“æ•™å¯º 8æ—¥ç´€è¡Œ</p>
</header>

<div class="container">
    
    <div id="view-itinerary" class="view-section active">
        <div class="weather-widget">
            <div>
                <div style="font-size:0.8rem; opacity:0.8;">å²¡å±± / å§¬è·¯ (12æœˆ)</div>
                <div style="font-weight:bold; font-size:1.4rem;">9Â°C</div>
            </div>
            <div class="weather-icon">â˜ï¸</div>
            <div style="font-size:0.8rem; text-align:right;">
                <div>é™é›¨æ©Ÿç‡: 20%</div>
                <div>é©åˆæ´‹è”¥å¼ç©¿æ­</div>
            </div>
        </div>

        <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
            <button class="btn btn-sm btn-outline" onclick="toggleEditMode()" id="editBtn">âœ ç·¨è¼¯è¡Œç¨‹</button>
        </div>

        <div id="itinerary-list">
            </div>
    </div>

    <div id="view-explore" class="view-section">
        <div class="category-scroll" id="main-cats">
            <button class="pill-btn active" onclick="selectCategory('play')">ç©æ¨‚</button>
            <button class="pill-btn" onclick="selectCategory('food')">ç¾é£Ÿ</button>
            <button class="pill-btn" onclick="selectCategory('health')">å¥åº·</button>
            <button class="pill-btn" onclick="selectCategory('convenience')">ä¾¿åˆ©</button>
        </div>
        <div class="sub-cats" id="sub-cats">
            </div>

        <div id="map"></div>
        <div id="places-results">
            <p style="text-align:center; color:#999; font-size:0.9rem;">é»æ“Šä¸Šæ–¹åˆ†é¡æœå°‹é™„è¿‘åœ°é»...</p>
        </div>
    </div>

    <div id="view-wallet" class="view-section">
        <div class="total-box">
            <small>ç¸½æ”¯å‡º</small><br>
            Â¥ <span id="total-expense">0</span>
        </div>

        <div class="card">
            <h3>æ–°å¢è¨˜å¸³</h3>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <input type="text" id="exp-name" placeholder="é …ç›® (å¦‚: çºœè»Š)" style="flex:2; padding:8px; border:1px solid #ccc; border-radius:4px;">
                <input type="number" id="exp-cost" placeholder="é‡‘é¡" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px;">
            </div>
            <button class="btn" style="width:100%; margin-top:10px;" onclick="addExpense()">+ åŠ å…¥</button>
        </div>

        <div id="expense-list" class="card" style="min-height: 200px;">
            </div>
    </div>

</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchView('itinerary', this)">
        <span class="nav-icon">ğŸ“…</span>è¡Œç¨‹
    </div>
    <div class="nav-item" onclick="switchView('explore', this)">
        <span class="nav-icon">ğŸ—ºï¸</span>æ¢ç´¢
    </div>
    <div class="nav-item" onclick="switchView('wallet', this)">
        <span class="nav-icon">ğŸ’°</span>è¨˜å¸³
    </div>
</nav>

<script>
    [cite_start]// --- 1. è³‡æ–™çµæ§‹åŒ– (è¡Œç¨‹è¡¨) [cite: 4, 5, 21, 35, 57, 71, 82, 96, 113] ---
    let itineraryData = [
        {
            day: "Day 1 (12/10)",
            title: "æŠµé”å²¡å±±",
            items: [
                { time: "TBD", content: "æŠµé”å²¡å±±æ©Ÿå ´ï¼Œæ­å·´å£«è‡³å²¡å±±è»Šç«™" },
                { time: "Check-in", content: "å¾Œæ¨‚åœ’é£¯åº— / é ˜JR Pass / è¥¿ç“œå¡å„²å€¼", note: "é«˜å³¶å±‹8Fé ˜Shopper's Card" }
            ]
        },
        {
            day: "Day 2 (12/11)",
            title: "é‡‘åˆ€æ¯”ç¾…å®®ãƒ»å¾Œæ¨‚åœ’",
            items: [
                { time: "08:52", content: "å²¡å±± â†’ ç´å¹³ (å—é¢¨è™Ÿ 1è™Ÿè»Šå»‚)" },
                { time: "10:00", content: "é‡‘åˆ€æ¯”ç¾…å®®åƒæ‹œ", note: "å»ºè­°æ­è¨ˆç¨‹è»Šè‡³ç¥æ¤¿å’–å•¡å»³(500éš)" },
                { time: "12:30", content: "åˆé¤ï¼šlwanoya çƒé¾éºµ" },
                { time: "13:47", content: "ç´å¹³ â†’ å²¡å±±" },
                { time: "15:45", content: "å²¡å±±å¾Œæ¨‚åœ’ / å²¡å±±åŸ", note: "è·¯é¢é›»è»Šè‡³åŸä¸‹ç«™" }
            ]
        },
        {
            day: "Day 3 (12/12)",
            title: "å§¬è·¯åŸãƒ»æ›¸å¯«å±±åœ“æ•™å¯º",
            items: [
                { time: "07:25", content: "å²¡å±± â†’ å§¬è·¯ (æ–°å¹¹ç·š)" },
                { time: "08:10", content: "æ­ç¥å§¬å·´å£«(#10) â†’ æ›¸å¯«å±±çºœè»Š" },
                { time: "09:00", content: "åœ“æ•™å¯ºå·¡ç¦®", note: "æœ«ä»£æ­¦å£«å–æ™¯åœ°ï¼Œéœå¿ƒé«”é©—" },
                { time: "12:00", content: "åˆé¤ï¼šé°»é­šé£¯ (Moriju)" },
                { time: "13:30", content: "å§¬è·¯åŸã€å¥½å¤åœ’" },
                { time: "17:36", content: "å§¬è·¯ â†’ å²¡å±±" }
            ]
        },
        {
            day: "Day 4 (12/13)",
            title: "å€‰æ•·ç¾è§€ â†’ ç§»å‹•è‡³æ¾å±±",
            items: [
                { time: "09:16", content: "å²¡å±± â†’ å€‰æ•·" },
                { time: "09:40", content: "å€‰æ•·ç¾è§€åœ°å€æ•£ç­–", note: "é˜¿æ™ºç¥ç¤¾ã€å€‰æ•·æ¡ƒå­ã€å»£æ¦®å ‚" },
                { time: "13:11", content: "å€‰æ•· â†’ å²¡å±± (å–è¡Œæ)" },
                { time: "14:35", content: "ç‰¹æ€¥å‰å¾€æ¾å±± (æ„›åª›)" },
                { time: "17:30", content: "å¤§è¡—é“é£¯åº— Check-in / æ™šé¤ï¼šç‚¸è±¬æ’" }
            ]
        },
        {
            day: "Day 5 (12/14)",
            title: "æ¾å±±åŸãƒ»é“å¾Œæº«æ³‰",
            items: [
                { time: "10:30", content: "æ¾å±±åŸ (çºœè»Š)ã€ä»Šæ²»æ¯›å·¾åº—" },
                { time: "13:00", content: "åˆé¤ï¼šé¯›é­šé£¯" },
                { time: "15:00", content: "é“å¾Œæº«æ³‰ Check-in", note: "æ³¨æ„ï¼šå°¾ç«¯é›»æ¢¯éœ€æ ¸å°èº«åˆ†" },
                { time: "16:00", content: "æº«æ³‰è¡—ã€å°‘çˆºæ©Ÿé—œé˜ã€é“å¾Œæº«æ³‰æœ¬é¤¨" }
            ]
        },
        {
            day: "Day 6 (12/15)",
            title: "ç€¨æˆ¶å…§æµ·æ¸¡è¼ª â†’ å»£å³¶",
            items: [
                { time: "10:50", content: "å‰å¾€æ¾å±±æ¸¯ (é›»è»Šè½‰å·´å£«)" },
                { time: "14:15", content: "æ­ä¹˜ SEA PASEO æ¸¡è¼ª", note: "æŒPASSæ›ç¥¨" },
                { time: "16:57", content: "æŠµé”å»£å³¶æ¸¯ â†’ å¸‚å€é£¯åº—" }
            ]
        },
        {
            day: "Day 7 (12/16)",
            title: "å®®å³¶åš´å³¶ç¥ç¤¾ãƒ»å»£å³¶å¸‚å€",
            items: [
                { time: "07:22", content: "å»£å³¶ â†’ å®®å³¶å£ â†’ æ¸¡è¼ª" },
                { time: "08:30", content: "åš´å³¶ç¥ç¤¾ã€å¤§é³¥å±…", note: "éœ€ä»˜ç™»å³¶ç¨… 100å††" },
                { time: "13:00", content: "è¿”å›å»£å³¶å¸‚å€" },
                { time: "14:30", content: "åŸçˆ†åœ“é ‚ã€å»£å³¶åŸ" },
                { time: "18:00", content: "å…«ä¸å €è³¼ç‰© (å”å‰è»»å¾·) / æ™šé¤ï¼šå»£å³¶ç‡’" }
            ]
        },
        {
            day: "Day 8 (12/17)",
            title: "è¿”ç¨‹",
            items: [
                { time: "07:15", content: "å»£å³¶ç«™æ­æ©Ÿå ´å·´å£«" },
                { time: "11:15", content: "é£›æ©Ÿèµ·é£› â†’ 13:10 æŠµé”æ¡ƒåœ’" }
            ]
        }
    ];

    let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
    let isEditMode = false;

    // --- 2. é›™å±¤é¸å–®è¨­å®š ---
    const categories = {
        play: { label: "ç©æ¨‚", subs: ["å…¬åœ’", "åšç‰©é¤¨", "ç¥ç¤¾", "è³¼ç‰©ä¸­å¿ƒ"] },
        food: { label: "ç¾é£Ÿ", subs: ["è¦ªå­é¤å»³", "ç‡’è‚‰", "å£½å¸", "å’–å•¡å»³", "æ‹‰éºµ"] },
        health: { label: "å¥åº·", subs: ["è—¥å¦åº—", "è¨ºæ‰€", "é†«é™¢", "å»æ‰€"] },
        convenience: { label: "ä¾¿åˆ©", subs: ["ä¾¿åˆ©å•†åº—", "è¶…å¸‚", "åœè»Šå ´", "è»Šç«™"] }
    };

    // --- 3. åˆå§‹åŒ– ---
    document.addEventListener('DOMContentLoaded', () => {
        renderItinerary();
        renderExpenses();
        initMap(); // å˜—è©¦åˆå§‹åŒ–åœ°åœ– (è‹¥ç„¡keyæœƒå ±éŒ¯ï¼Œä½†ä¸å½±éŸ¿å…¶ä»–åŠŸèƒ½)
        selectCategory('play'); // é è¨­é¸å–®
    });

    // --- 4. é é¢åˆ‡æ›é‚è¼¯ ---
    function switchView(viewName, navEl) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${viewName}`).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        navEl.classList.add('active');
        
        // å¦‚æœåˆ‡æ›åˆ°åœ°åœ–ï¼Œé‡æ–°èª¿æ•´å¤§å°ä»¥å…é¡¯ç¤ºéŒ¯èª¤
        if(viewName === 'explore' && map) {
            setTimeout(() => google.maps.event.trigger(map, "resize"), 100);
        }
    }

    // --- 5. è¡Œç¨‹è¡¨åŠŸèƒ½ (å«ç·¨è¼¯èˆ‡æ‹–æ›³ UI) ---
    function renderItinerary() {
        const container = document.getElementById('itinerary-list');
        container.innerHTML = '';

        itineraryData.forEach((day, index) => {
            const dayHTML = `
                <div class="card ${isEditMode ? 'edit-mode' : ''}">
                    <div class="day-header" onclick="toggleDay(${index})">
                        <span>${day.day} ${day.title}</span>
                        <span>â–¼</span>
                    </div>
                    <div class="day-details" id="day-${index}" ${index === 0 ? 'class="day-details open"' : ''}>
                        ${day.items.map((item, itemIdx) => `
                            <div class="timeline-item" draggable="${isEditMode}" ondragstart="drag(event, ${index}, ${itemIdx})" ondrop="drop(event, ${index}, ${itemIdx})" ondragover="allowDrop(event)">
                                <span class="time-badge">${item.time}</span>
                                <span contenteditable="${isEditMode}" onblur="updateItem(${index}, ${itemIdx}, 'content', this.innerText)">${item.content}</span>
                                ${item.note ? `<div style="font-size:0.8rem; color:#888; margin-top:2px;">âš ï¸ ${item.note}</div>` : ''}
                                ${isEditMode ? `<span class="drag-handle" onclick="deleteItem(${index}, ${itemIdx})">ğŸ—‘ï¸</span>` : ''}
                            </div>
                        `).join('')}
                        ${isEditMode ? `<button class="btn btn-sm btn-outline" onclick="addItem(${index})">+ æ–°å¢é …ç›®</button>` : ''}
                    </div>
                </div>
            `;
            container.innerHTML += dayHTML;
        });
        
        // é è¨­å±•é–‹ç¬¬ä¸€å¤©
        if(!isEditMode) document.getElementById('day-0').classList.add('open');
    }

    function toggleDay(index) {
        const el = document.getElementById(`day-${index}`);
        el.classList.toggle('open');
    }

    function toggleEditMode() {
        isEditMode = !isEditMode;
        document.getElementById('editBtn').innerText = isEditMode ? 'å®Œæˆ' : 'âœ ç·¨è¼¯è¡Œç¨‹';
        document.getElementById('editBtn').className = isEditMode ? 'btn btn-sm btn-danger' : 'btn btn-sm btn-outline';
        renderItinerary();
    }

    // ç°¡å–®çš„è³‡æ–™æ›´æ–° (å¯¦ä½œç¤ºæ„)
    function updateItem(dayIdx, itemIdx, field, val) { itineraryData[dayIdx].items[itemIdx][field] = val; }
    function deleteItem(dayIdx, itemIdx) { itineraryData[dayIdx].items.splice(itemIdx, 1); renderItinerary(); }
    function addItem(dayIdx) { itineraryData[dayIdx].items.push({time:"--:--", content:"æ–°è¡Œç¨‹"}); renderItinerary(); }
    
    // æ‹–æ›³åŠŸèƒ½ (ç°¡åŒ–ç‰ˆ)
    let dragSrc = null;
    function allowDrop(ev) { ev.preventDefault(); }
    function drag(ev, dayIdx, itemIdx) { dragSrc = {d:dayIdx, i:itemIdx}; }
    function drop(ev, dayIdx, itemIdx) {
        ev.preventDefault();
        if(dragSrc.d === dayIdx) {
            const items = itineraryData[dayIdx].items;
            const [moved] = items.splice(dragSrc.i, 1);
            items.splice(itemIdx, 0, moved);
            renderItinerary();
        }
    }

    // --- 6. åœ°åœ–èˆ‡æœå°‹ (Google Maps API + AI å»ºè­°) ---
    let map, service, infoWindow;

    function initMap() {
        // è‹¥æ²’æœ‰ API Keyï¼Œé€™è£¡æœƒå ±éŒ¯ï¼Œå› æ­¤éœ€åŒ…åœ¨ try catch æˆ–ç­‰å¾…è¼‰å…¥
        if (typeof google === 'undefined') return;

        navigator.geolocation.getCurrentPosition((position) => {
            const userLoc = { lat: position.coords.latitude, lng: position.coords.longitude };
            // è‹¥ä¸åœ¨æ—¥æœ¬ï¼Œé è¨­åˆ°å²¡å±±è»Šç«™ (34.6663, 133.9185) æ–¹ä¾¿é è¦½
            const center = (userLoc.lat > 30 && userLoc.lat < 46 && userLoc.lng > 128) ? userLoc : { lat: 34.6663, lng: 133.9185 };

            map = new google.maps.Map(document.getElementById("map"), {
                center: center,
                zoom: 14,
                styles: [ /* ç°¡æ˜“çš„å¾©å¤åœ°åœ–æ¨£å¼ */
                    { "featureType": "landscape", "stylers": [{ "color": "#f5f5f5" }] },
                    { "featureType": "poi.park", "stylers": [{ "color": "#dedede" }] }
                ]
            });
            service = new google.maps.places.PlacesService(map);
            
            new google.maps.Marker({ position: center, map: map, title: "ç¾åœ¨ä½ç½®" });
        }, () => {
            // å®šä½å¤±æ•— fallback
            console.log("å®šä½å¤±æ•—");
        });
    }

    function selectCategory(catKey) {
        // æ›´æ–° UI
        document.querySelectorAll('#main-cats .pill-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        // ç”Ÿæˆå­æŒ‰éˆ•
        const subContainer = document.getElementById('sub-cats');
        subContainer.innerHTML = categories[catKey].subs.map(sub => 
            `<div class="sub-pill" onclick="searchPlaces('${sub}')">${sub}</div>`
        ).join('');
    }

    function searchPlaces(query) {
        if (!map || !service) {
            alert("è«‹å…ˆè¨­å®š Google Maps API Key æ‰èƒ½æœå°‹åœ°åœ–ã€‚");
            // æ¨¡æ“¬æœå°‹çµæœ (ç„¡ API æ™‚çš„é«”é©—)
            renderMockResults(query);
            return;
        }

        const request = {
            location: map.getCenter(),
            radius: '1000',
            query: query,
            openNow: true
        };

        service.textSearch(request, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                renderResults(results, query);
            }
        });
    }

    // AI å»ºè­°ç”Ÿæˆå™¨ (çˆ¸åª½è¦–è§’)
    function generateAiTip(placeType, name) {
        const n = name || "";
        if (n.includes("ç‡’è‚‰") || placeType.includes("bbq")) return "æ³¨æ„ç‚­ç«ä½ç½®ï¼Œé¿å…å­©å­ç‡™å‚·ã€‚";
        if (n.includes("å±…é…’å±‹")) return "ç¢ºèªæ˜¯å¦æœ‰ç¦è¸å€ï¼Œæˆ–é©åˆå…’ç«¥çš„æ–™ç†ã€‚";
        if (placeType.includes("park")) return "åˆ¥å¿˜äº†å¸¶é˜²èšŠæ¶²èˆ‡ä¹¾æ´—æ‰‹ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰å…¬å»ã€‚";
        if (n.includes("åœ“æ•™å¯º") || n.includes("åŸ")) return "éšæ¢¯è¼ƒå¤šï¼Œè‹¥æœ‰æ¨è»Šå»ºè­°å¯„æ”¾ï¼Œæº–å‚™æ¹å·¾ã€‚";
        if (placeType.includes("drugstore")) return "å¯åœ¨æ­¤è³¼è²·å…’ç«¥é€€ç†±è²¼èˆ‡é˜²æ›¬ä¹³ã€‚";
        if (placeType.includes("convenience_store")) return "å¯è³¼è²·é£¯ç³°æˆ–ç‰›å¥¶ä½œç‚ºå­©å­å‚™ç”¨ç³§é£Ÿã€‚";
        return "äººæ½®æ“æ“ æ™‚è«‹ç‰½å¥½å­©å­çš„æ‰‹ã€‚";
    }

    function renderResults(results, typeStr) {
        const container = document.getElementById('places-results');
        container.innerHTML = '';
        
        // æ¸…é™¤èˆŠ Markers (ç°¡åŒ–ç•¥é)

        results.slice(0, 5).forEach(place => {
            const tip = generateAiTip(place.types.join(' '), place.name + " " + typeStr);
            const html = `
                <div class="place-card">
                    <div style="font-weight:bold;">${place.name}</div>
                    <div style="font-size:0.8rem; color:#666;">â­ ${place.rating || 'ç„¡è©•åˆ†'} Â· ${place.formatted_address || 'é™„è¿‘'}</div>
                    <div class="ai-tip">çˆ¸åª½ Noteï¼š${tip}</div>
                </div>
            `;
            container.innerHTML += html;
        });
    }

    // æ¨¡æ“¬æœå°‹çµæœ (ç•¶æ²’æœ‰ API Key æ™‚é¡¯ç¤º)
    function renderMockResults(query) {
        const container = document.getElementById('places-results');
        container.innerHTML = `
            <div class="place-card">
                <div style="font-weight:bold;">(ç¯„ä¾‹) é™„è¿‘çš„${query}</div>
                <div style="font-size:0.8rem; color:#666;">â­ 4.5 Â· æ­¥è¡Œ 5 åˆ†é˜</div>
                <div class="ai-tip">çˆ¸åª½ Noteï¼š${generateAiTip('mock', query)}</div>
            </div>
            <div style="text-align:center; margin-top:10px; color:red; font-size:0.8rem;">
                * å¯¦éš›æœå°‹éœ€å¡«å…¥ API Key
            </div>
        `;
    }

    // --- 7. è¨˜å¸³åŠŸèƒ½ ---
    function renderExpenses() {
        const list = document.getElementById('expense-list');
        const totalEl = document.getElementById('total-expense');
        list.innerHTML = '';
        let total = 0;

        expenses.forEach((ex, idx) => {
            total += parseInt(ex.cost);
            list.innerHTML += `
                <div class="expense-row">
                    <span>${ex.name}</span>
                    <span>Â¥${ex.cost} <span onclick="removeExpense(${idx})" style="color:red; margin-left:5px; cursor:pointer;">x</span></span>
                </div>
            `;
        });
        totalEl.innerText = total.toLocaleString();
    }

    function addExpense() {
        const name = document.getElementById('exp-name').value;
        const cost = document.getElementById('exp-cost').value;
        if(name && cost) {
            expenses.push({name, cost});
            localStorage.setItem('expenses', JSON.stringify(expenses));
            renderExpenses();
            document.getElementById('exp-name').value = '';
            document.getElementById('exp-cost').value = '';
        }
    }
    
    function removeExpense(idx) {
        expenses.splice(idx, 1);
        localStorage.setItem('expenses', JSON.stringify(expenses));
        renderExpenses();
    }

</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places&callback=initMap"></script>

</body>
</html>
