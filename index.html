<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ›¸å¯«å±±ãƒ»å·¡ç¦®å¸– | 8æ—¥å‘¨éŠ (åµéŒ¯ç‰ˆ)</title>
    <style>
        /* --- è¦–è¦ºé¢¨æ ¼è¨­å®š --- */
        :root {
            --c-bg: #f4f1ea; --c-text: #2c2825; --c-primary: #5c6e58;
            --c-primary-dark: #3a4a36; --c-accent: #a63737; --c-wood: #8c7b6c;
            --c-light: #e8e4dc; --c-white: #ffffff;
            --shadow: 0 4px 12px rgba(44, 40, 37, 0.08); --radius: 12px;
            --font-main: "Helvetica Neue", Helvetica, "PingFang TC", "Microsoft JhengHei", sans-serif;
            --font-serif: "Songti TC", "Noto Serif TC", serif;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: var(--font-main); background-color: var(--c-bg); color: var(--c-text); padding-bottom: 90px; }
        header { text-align: center; padding: 20px 0; background: linear-gradient(to bottom, var(--c-bg), rgba(244,241,234,0)); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(5px); }
        header h1 { font-family: var(--font-serif); font-size: 1.6rem; color: var(--c-primary-dark); margin: 0; }
        header p { font-size: 0.85rem; color: var(--c-wood); margin-top: 4px; letter-spacing: 1px; }
        .container { max-width: 600px; margin: 0 auto; padding: 0 16px; }
        .card { background: var(--c-white); border-radius: var(--radius); padding: 16px; margin-bottom: 16px; box-shadow: var(--shadow); border-left: 4px solid var(--c-primary); }
        .btn { background: var(--c-primary); color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .day-header { background: var(--c-wood); color: white; padding: 12px 16px; border-radius: var(--radius); margin-bottom: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .day-details { display: none; padding: 8px 0 8px 12px; border-left: 2px dashed var(--c-light); margin-left: 10px; }
        .day-details.open { display: block; animation: slideDown 0.3s ease-out; }
        .timeline-item { position: relative; padding-left: 24px; margin-bottom: 16px; }
        .timeline-item::before { content: ''; position: absolute; left: -5px; top: 6px; width: 12px; height: 12px; background: var(--c-accent); border-radius: 50%; border: 2px solid var(--c-white); }
        .time-badge { font-size: 0.75rem; background: var(--c-primary-dark); color: white; padding: 2px 8px; border-radius: 4px; margin-right: 6px; font-weight: bold; vertical-align: middle; }
        #map { width: 100%; height: 50vh; border-radius: var(--radius); margin-bottom: 16px; background: #eee; position: relative; }
        .category-scroll { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 10px; margin-bottom: 10px; }
        .pill-btn { white-space: nowrap; padding: 8px 16px; border-radius: 20px; background: var(--c-white); border: 1px solid var(--c-wood); color: var(--c-text); font-size: 0.9rem; transition: 0.2s; cursor: pointer; }
        .pill-btn.active { background: var(--c-primary); color: white; border-color: var(--c-primary); }
        .sub-cats { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
        .sub-pill { font-size: 0.8rem; background: #e0e0e0; padding: 4px 10px; border-radius: 12px; cursor: pointer; color: #555; }
        .place-card { background: white; padding: 12px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid var(--c-accent); box-shadow: var(--shadow); }
        .ai-tip { background: #fff8e1; color: #856404; font-size: 0.85rem; padding: 8px; margin-top: 8px; border-radius: 6px; line-height: 1.4; display: flex; align-items: start; }
        .ai-tip::before { content: 'ğŸ’¡'; margin-right: 6px; }
        .total-box { background: var(--c-primary-dark); color: white; padding: 20px; border-radius: var(--radius); text-align: right; margin-bottom: 20px; }
        .expense-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 10px 0; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--c-white); border-top: 1px solid #eee; display: flex; justify-content: space-around; padding: 10px 0; z-index: 999; }
        .nav-item { text-align: center; color: #999; font-size: 0.7rem; flex: 1; cursor: pointer; }
        .nav-item.active { color: var(--c-primary); font-weight: bold; }
        .nav-icon { display: block; font-size: 1.4rem; margin-bottom: 2px; }
        .view-section { display: none; opacity: 0; transition: opacity 0.3s; }
        .view-section.active { display: block; opacity: 1; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* éŒ¯èª¤è¨Šæ¯æ¨£å¼ */
        .error-msg { color: #a63737; padding: 20px; text-align: center; background: #fff0f0; border: 1px solid #ffcccc; border-radius: 8px; font-weight: bold; }
    </style>
</head>
<body>

<header>
    <h1>æ›¸å¯«å±±ãƒ»å·¡ç¦®å¸–</h1>
    <p>ä¸­åœ‹å››åœ‹ Ã— åœ“æ•™å¯º 8æ—¥ç´€è¡Œ</p>
</header>

<div class="container">
    <div id="view-itinerary" class="view-section active">
        <div class="card" style="background: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%); color: white; border:none; display:flex; align-items:center; justify-content:space-between;">
            <div><div style="font-size:0.9rem; opacity:0.8;">12æœˆ / å²¡å±±ãƒ»å§¬è·¯</div><div style="font-size:1.8rem; font-weight:bold;">9Â°C</div></div>
            <div style="text-align:right;"><div style="font-size:2rem;">â˜ï¸</div><div style="font-size:0.8rem;">é©åˆæ´‹è”¥å¼ç©¿æ­</div></div>
        </div>
        <div id="itinerary-list"></div>
    </div>

    <div id="view-explore" class="view-section">
        <div class="category-scroll">
            <button class="pill-btn active" onclick="selectMainCat('play', this)">ç©æ¨‚</button>
            <button class="pill-btn" onclick="selectMainCat('food', this)">ç¾é£Ÿ</button>
            <button class="pill-btn" onclick="selectMainCat('health', this)">å¥åº·</button>
            <button class="pill-btn" onclick="selectMainCat('conv', this)">ä¾¿åˆ©</button>
        </div>
        <div class="sub-cats" id="sub-cats-container"></div>
        <div id="map"></div>
        <div id="places-results">
            <p id="loading-text" style="text-align:center; color:#888; font-size:0.9rem; margin-top:20px;">
                æ­£åœ¨è¯ç¹« Google Maps è¡›æ˜Ÿ...<br>
                <small>(å¦‚æœå¡ä½è¶…é 5 ç§’ï¼Œè¡¨ç¤º API Key è¨­å®šæœ‰èª¤)</small>
            </p>
        </div>
    </div>

    <div id="view-wallet" class="view-section">
        <div class="total-box"><small>ç¸½æ”¯å‡º</small><div style="font-size:2rem; font-weight:bold;">Â¥ <span id="total-val">0</span></div></div>
        <div class="card">
            <h3>ğŸ–Šï¸ æ–°å¢è¨˜å¸³</h3>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <input type="text" id="input-item" placeholder="é …ç›®" style="flex:2;">
                <input type="number" id="input-cost" placeholder="é‡‘é¡" style="flex:1;">
            </div>
            <button class="btn" style="width:100%; margin-top:10px;" onclick="addExpense()">åŠ å…¥</button>
        </div>
        <div class="card" id="expense-list" style="min-height:100px;"></div>
    </div>
</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchView('itinerary', this)"><span class="nav-icon">ğŸ“…</span>è¡Œç¨‹</div>
    <div class="nav-item" onclick="switchView('explore', this)"><span class="nav-icon">ğŸ—ºï¸</span>æ¢ç´¢</div>
    <div class="nav-item" onclick="switchView('wallet', this)"><span class="nav-icon">ğŸ’°</span>è¨˜å¸³</div>
</nav>

<script>
    // --- éŒ¯èª¤åµæ¸¬ (å…¨åŸŸ) ---
    window.gm_authFailure = function() {
        const errorDiv = document.getElementById('places-results');
        errorDiv.innerHTML = `
            <div class="error-msg">
                âš ï¸ Google Maps é©—è­‰å¤±æ•—<br>
                <div style="font-size:0.8rem; font-weight:normal; margin-top:8px; text-align:left;">
                å¯èƒ½åŸå› ï¼š<br>
                1. API Key ä¸æ­£ç¢º<br>
                2. æœªå•Ÿç”¨ "Maps JavaScript API" æˆ– "Places API"<br>
                3. è¨ˆè²»å¸³æˆ¶æœªé€£çµ<br>
                4. è‹¥æ˜¯æœ¬åœ°æ¸¬è©¦ï¼Œè«‹å°‡ Key é™åˆ¶è¨­ç‚º "None"
                </div>
            </div>
        `;
        // å˜—è©¦ç§»é™¤åœ°åœ–å€å¡Šé¿å…ç°è‰²é†œé†œçš„
        document.getElementById('map').style.display = 'none';
    }

    // --- è³‡æ–™ ---
    const itineraryData = [
        { day: "Day 1 (12/10)", title: "æŠµé”å²¡å±±", items: [{t:"11:40", c:"æŠµé”å²¡å±±æ©Ÿå ´"}, {t:"15:00", c:"Check-in å¾Œæ¨‚åœ’é£¯åº—"}]},
        { day: "Day 2 (12/11)", title: "é‡‘åˆ€æ¯”ç¾…å®®", items: [{t:"10:00", c:"é‡‘åˆ€æ¯”ç¾…å®®"}, {t:"15:45", c:"å²¡å±±å¾Œæ¨‚åœ’"}]},
        { day: "Day 3 (12/12)", title: "å§¬è·¯ãƒ»æ›¸å¯«å±±", items: [{t:"09:00", c:"åœ“æ•™å¯º"}, {t:"13:30", c:"å§¬è·¯åŸ"}]},
        { day: "Day 4 (12/13)", title: "å€‰æ•· -> æ¾å±±", items: [{t:"09:40", c:"å€‰æ•·ç¾è§€"}, {t:"17:30", c:"æ¾å±± Check-in"}]},
        { day: "Day 5 (12/14)", title: "æ¾å±±åŸãƒ»é“å¾Œ", items: [{t:"10:30", c:"æ¾å±±åŸ"}, {t:"16:00", c:"é“å¾Œæº«æ³‰"}]},
        { day: "Day 6 (12/15)", title: "æ¸¡è¼ª -> å»£å³¶", items: [{t:"14:15", c:"SEA PASEO æ¸¡è¼ª"}, {t:"16:57", c:"æŠµé”å»£å³¶"}]},
        { day: "Day 7 (12/16)", title: "å®®å³¶ãƒ»å»£å³¶", items: [{t:"08:30", c:"åš´å³¶ç¥ç¤¾"}, {t:"14:30", c:"åŸçˆ†åœ“é ‚"}]},
        { day: "Day 8 (12/17)", title: "è¿”ç¨‹", items: [{t:"07:15", c:"å‰å¾€æ©Ÿå ´"}, {t:"11:15", c:"é£›æ©Ÿèµ·é£›"}]}
    ];
    const categories = {
        play: { label: "ç©æ¨‚", subs: ["å…¬åœ’", "åšç‰©é¤¨", "ç¥ç¤¾", "è³¼ç‰©ä¸­å¿ƒ"] },
        food: { label: "ç¾é£Ÿ", subs: ["è¦ªå­é¤å»³", "ç‡’è‚‰", "å£½å¸", "æ‹‰éºµ"] },
        health: { label: "å¥åº·", subs: ["è—¥å¦åº—", "è¨ºæ‰€", "é†«é™¢", "å»æ‰€"] },
        conv: { label: "ä¾¿åˆ©", subs: ["ä¾¿åˆ©å•†åº—", "è¶…å¸‚", "è»Šç«™", "åœè»Šå ´"] }
    };
    
    let map, service, infowindow;
    let markers = [];
    let expenses = [];
    try { expenses = JSON.parse(localStorage.getItem('tripExp')) || []; } catch(e){ expenses=[]; }

    // å®šç¾©å…¨åŸŸéŒ¯èª¤è™•ç† (è®“éŒ¯èª¤ç›´æ¥å½ˆå‡ºä¾†)
    window.gm_authFailure = function() {
        alert("ğŸ”´ Google Maps é©—è­‰å¤±æ•—ï¼\n\nè«‹æª¢æŸ¥ API Key æ˜¯å¦æ­£ç¢ºï¼Œæˆ–æ˜¯å¦å·²å•Ÿç”¨è¨ˆè²»å¸³æˆ¶ã€‚");
        document.getElementById('loading-text').innerHTML = "<span style='color:red; font-weight:bold;'>é©—è­‰å¤±æ•— (Auth Failure)</span>";
    };

    // --- åˆå§‹åŒ– ---
    document.addEventListener('DOMContentLoaded', () => {
        renderItinerary();
        renderExpenses();
        // å˜—è©¦åˆå§‹åŒ–
        if(typeof google === 'undefined') {
            document.getElementById('loading-text').innerText = "âš ï¸ ç„¡æ³•é€£æ¥ Google ä¼ºæœå™¨ (ç¶²è·¯å•é¡Œæˆ– Key éŒ¯èª¤)";
        }
    });

    // --- Map Functions ---
    window.initMap = function() {
        // æ¸¬è©¦ API æ˜¯å¦èƒ½é‹ä½œ
        try {
            const mapEl = document.getElementById("map");
            const map = new google.maps.Map(mapEl, {
                center: { lat: 34.6663, lng: 133.9185 },
                zoom: 15
            });

            const service = new google.maps.places.PlacesService(map);
            // å˜—è©¦æœå°‹ä¸€å€‹ç°¡å–®åœ°é»ä¾†æ¸¬è©¦
            service.findPlaceFromQuery({
                query: "7-Eleven",
                fields: ["name", "geometry"]
            }, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    alert("âœ… æˆåŠŸï¼API Key é‹ä½œæ­£å¸¸ã€‚");
                    document.getElementById('loading-text').style.display = 'none';
                    // é€™è£¡å¯ä»¥ç¹¼çºŒåŸ·è¡ŒåŸæœ¬çš„é‚è¼¯...
                } else {
                    alert("âŒ åœ°åœ–è¼‰å…¥æˆåŠŸï¼Œä½†ã€Œæœå°‹åŠŸèƒ½ã€å¤±æ•—ã€‚\n\néŒ¯èª¤ä»£ç¢¼ï¼š" + status + "\n\nè«‹ç¢ºèª Google Cloud Console æœ‰å•Ÿç”¨ 'Places API'ã€‚");
                }
            });

        } catch (e) {
            alert("âŒ ç¨‹å¼åŸ·è¡ŒéŒ¯èª¤ï¼š\n" + e.message);
        }
    };

    // --- åœ°åœ–é‚è¼¯ ---
    window.initMap = function() {
        // å®šä½é‚è¼¯
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (p) => createMap({ lat: p.coords.latitude, lng: p.coords.longitude }),
                () => createMap({ lat: 34.6663, lng: 133.9185 }) // å®šä½å¤±æ•—é è¨­å²¡å±±
            );
        } else {
            createMap({ lat: 34.6663, lng: 133.9185 });
        }
    };

    function createMap(centerPos) {
        const mapEl = document.getElementById("map");
        if(!mapEl) return;
        
        try {
            map = new google.maps.Map(mapEl, {
                center: centerPos, zoom: 15, disableDefaultUI: true,
                styles: [{ "featureType": "landscape", "stylers": [{ "color": "#f5f5f5" }] }]
            });

            new google.maps.Marker({
                position: centerPos, map: map, title: "ç›®å‰ä½ç½®",
                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#4285F4", fillOpacity: 1, strokeWeight: 2, strokeColor: "white" }
            });

            service = new google.maps.places.PlacesService(map);
            infowindow = new google.maps.InfoWindow();
            
            // åœ°åœ–æˆåŠŸè¼‰å…¥ï¼Œç«‹åˆ»åŸ·è¡Œç¬¬ä¸€æ¬¡æœå°‹
            const currentSub = document.querySelector('.sub-pill'); 
            if(currentSub) searchNearby(currentSub.innerText);
            
        } catch (e) {
            console.error("Map Error:", e);
            document.getElementById('places-results').innerText = "åœ°åœ–åˆå§‹åŒ–éŒ¯èª¤: " + e.message;
        }
    }

    function searchNearby(query) {
        if (!service) {
            // åœ°åœ–é‚„æ²’æº–å‚™å¥½ï¼Œç¨å¾Œå†è©¦
            return;
        }
        
        const request = { location: map.getCenter(), radius: '1000', query: query }; // ç§»é™¤ openNow å¢åŠ æœå°‹æˆåŠŸç‡
        markers.forEach(m => m.setMap(null)); markers = [];
        
        document.getElementById('places-results').innerHTML = '<p style="text-align:center;">ğŸ” æ­£åœ¨æœå°‹é™„è¿‘çš„ ' + query + '...</p>';

        service.textSearch(request, (results, status) => {
            const container = document.getElementById('places-results');
            if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                renderPlacesList(results, query);
                const bounds = new google.maps.LatLngBounds();
                results.forEach(place => {
                    createMarker(place);
                    if (place.geometry.viewport) bounds.union(place.geometry.viewport);
                    else bounds.extend(place.geometry.location);
                });
                map.fitBounds(bounds);
            } else {
                // å¦‚æœå›å‚³ ZERO_RESULTS æˆ–å…¶ä»–ç‹€æ…‹
                container.innerHTML = `
                    <p style="text-align:center; padding:20px; color:#888;">
                        é™„è¿‘æ‰¾ä¸åˆ°ã€Œ${query}ã€ã€‚<br>
                        <small>API å›æ‡‰ç‹€æ…‹: ${status}</small>
                    </p>`;
            }
        });
    }

    function createMarker(place) {
        const marker = new google.maps.Marker({ map: map, position: place.geometry.location });
        google.maps.event.addListener(marker, "click", () => {
            infowindow.setContent(`<strong>${place.name}</strong><br>${place.formatted_address}`);
            infowindow.open(map, marker);
        });
        markers.push(marker);
    }
    
    function renderPlacesList(results, query) {
        const container = document.getElementById('places-results');
        container.innerHTML = '';
        results.slice(0, 10).forEach(place => {
            const tip = generateAiTip(place, query);
            container.innerHTML += `
                <div class="place-card" onclick="panToPlace('${place.place_id}')">
                    <div style="font-weight:bold;">${place.name}</div>
                    <div style="font-size:0.8rem; color:#666; margin:4px 0;">â­ ${place.rating || '-'}</div>
                    <div class="ai-tip">çˆ¸åª½ Noteï¼š${tip}</div>
                </div>`;
        });
    }
    
    function generateAiTip(place, query) {
        const types = place.types ? place.types.join(' ') : '';
        if (query.includes("ç‡’è‚‰")) return "æ³¨æ„ç‚­ç«å®‰å…¨ã€‚";
        if (types.includes("park")) return "åˆ¥å¿˜äº†é˜²èšŠæ¶²ã€‚";
        if (types.includes("convenience")) return "å¯è£œçµ¦ç‰›å¥¶é£¯ç³°ã€‚";
        return "äººæ½®æ“æ“ æ™‚è«‹ç‰½å¥½å­©å­ã€‚";
    }

    // --- UI äº’å‹• ---
    window.panToPlace = function(placeId) {
        service.getDetails({ placeId: placeId }, (place, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                map.setCenter(place.geometry.location); map.setZoom(17);
            }
        });
    };
    window.selectMainCat = function(key, btn) {
        if(btn) {
            document.querySelectorAll('.category-scroll .pill-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        const subContainer = document.getElementById('sub-cats-container');
        subContainer.innerHTML = categories[key].subs.map(sub => 
            `<div class="sub-pill" onclick="searchNearby('${sub}')">${sub}</div>`
        ).join('');
        
        // å¦‚æœåœ°åœ–å·²ç¶“æº–å‚™å¥½ï¼Œå°±ç›´æ¥æœå°‹ç¬¬ä¸€å€‹å­åˆ†é¡
        if(service) searchNearby(categories[key].subs[0]);
    };
    window.switchView = function(viewName, navEl) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${viewName}`).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        navEl.classList.add('active');
        if(viewName === 'explore' && map) setTimeout(() => google.maps.event.trigger(map, "resize"), 100);
    };
    window.toggleDay = function(idx) { document.getElementById(`day-${idx}`).classList.toggle('open'); };
    
    // è¡Œç¨‹èˆ‡è¨˜å¸³æ¸²æŸ“
    function renderItinerary() {
        document.getElementById('itinerary-list').innerHTML = itineraryData.map((day, idx) => `
            <div class="card"><div class="day-header" onclick="toggleDay(${idx})"><b>${day.day} ${day.title}</b><span>â–¼</span></div>
            <div class="day-details ${idx===0?'open':''}" id="day-${idx}">${day.items.map(i=>`<div class="timeline-item"><span class="time-badge">${i.t}</span>${i.c}</div>`).join('')}</div></div>
        `).join('');
    }
    function renderExpenses() {
        let total=0;
        document.getElementById('expense-list').innerHTML = expenses.map((ex, i) => {
            total+=Number(ex.cost);
            return `<div class="expense-item"><span>${ex.item}</span><span>Â¥${Number(ex.cost).toLocaleString()} <span onclick="delExpense(${i})" style="color:red;margin-left:8px;cursor:pointer;">Ã—</span></span></div>`;
        }).join('');
        document.getElementById('total-val').innerText = total.toLocaleString();
    }
    window.addExpense = function() {
        const item=document.getElementById('input-item').value, cost=document.getElementById('input-cost').value;
        if(item&&cost) { expenses.push({item, cost}); localStorage.setItem('tripExp', JSON.stringify(expenses)); renderExpenses(); document.getElementById('input-item').value=''; document.getElementById('input-cost').value=''; }
    };
    window.delExpense = function(i) { expenses.splice(i, 1); localStorage.setItem('tripExp', JSON.stringify(expenses)); renderExpenses(); };
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARy8kyAOrvlptzGYKaqR04QrZIxEUt6KI&libraries=places&callback=initMap&loading=async"></script>

</body>
</html>
