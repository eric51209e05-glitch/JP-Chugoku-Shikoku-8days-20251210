<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ›¸å¯«å±±ãƒ»å·¡ç¦®å¸– | 8æ—¥å‘¨éŠ</title>
    <style>
        /* --- è¦–è¦ºé¢¨æ ¼è¨­å®š --- */
        :root {
            --c-bg: #f4f1ea;
            --c-text: #2c2825;
            --c-primary: #5c6e58;
            --c-primary-dark: #3a4a36;
            --c-accent: #a63737;
            --c-wood: #8c7b6c;
            --c-light: #e8e4dc;
            --c-white: #ffffff;
            --shadow: 0 4px 12px rgba(44, 40, 37, 0.08);
            --radius: 12px;
            --font-main: "Helvetica Neue", Helvetica, "PingFang TC", "Microsoft JhengHei", sans-serif;
            --font-serif: "Songti TC", "Noto Serif TC", serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0;
            font-family: var(--font-main);
            background-color: var(--c-bg);
            color: var(--c-text);
            padding-bottom: 90px;
        }

        header {
            text-align: center; padding: 20px 0;
            background: linear-gradient(to bottom, var(--c-bg), rgba(244,241,234,0));
            position: sticky; top: 0; z-index: 100;
            backdrop-filter: blur(5px);
        }
        header h1 { font-family: var(--font-serif); font-size: 1.6rem; color: var(--c-primary-dark); margin: 0; }
        header p { font-size: 0.85rem; color: var(--c-wood); margin-top: 4px; letter-spacing: 1px; }

        .container { max-width: 600px; margin: 0 auto; padding: 0 16px; }

        .card {
            background: var(--c-white);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--c-primary);
        }

        .btn {
            background: var(--c-primary); color: white; border: none;
            padding: 8px 16px; border-radius: 20px; cursor: pointer;
            font-size: 0.9rem; transition: 0.2s;
        }
        .btn:active { transform: scale(0.98); }

        .day-header {
            background: var(--c-wood); color: white;
            padding: 12px 16px; border-radius: var(--radius);
            margin-bottom: 10px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .day-details { display: none; padding: 8px 0 8px 12px; border-left: 2px dashed var(--c-light); margin-left: 10px; }
        .day-details.open { display: block; animation: slideDown 0.3s ease-out; }
        
        .timeline-item { position: relative; padding-left: 24px; margin-bottom: 16px; }
        .timeline-item::before {
            content: ''; position: absolute; left: -5px; top: 6px;
            width: 12px; height: 12px; background: var(--c-accent); border-radius: 50%; border: 2px solid var(--c-white);
        }
        .time-badge {
            font-size: 0.75rem; background: var(--c-primary-dark); color: white;
            padding: 2px 8px; border-radius: 4px; margin-right: 6px; font-weight: bold; vertical-align: middle;
        }

        #map { width: 100%; height: 50vh; border-radius: var(--radius); margin-bottom: 16px; background: #eee; }
        
        .category-scroll { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 10px; margin-bottom: 10px; }
        .pill-btn {
            white-space: nowrap; padding: 8px 16px; border-radius: 20px;
            background: var(--c-white); border: 1px solid var(--c-wood);
            color: var(--c-text); font-size: 0.9rem; transition: 0.2s; cursor: pointer;
        }
        .pill-btn.active { background: var(--c-primary); color: white; border-color: var(--c-primary); }
        
        .sub-cats { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
        .sub-pill { font-size: 0.8rem; background: #e0e0e0; padding: 4px 10px; border-radius: 12px; cursor: pointer; color: #555; }

        .place-card {
            background: white; padding: 12px; margin-bottom: 10px;
            border-radius: 8px; border-left: 4px solid var(--c-accent); box-shadow: var(--shadow);
        }
        .ai-tip {
            background: #fff8e1; color: #856404; font-size: 0.85rem;
            padding: 8px; margin-top: 8px; border-radius: 6px; line-height: 1.4; display: flex; align-items: start;
        }
        .ai-tip::before { content: 'ğŸ’¡'; margin-right: 6px; }

        .total-box {
            background: var(--c-primary-dark); color: white;
            padding: 20px; border-radius: var(--radius);
            text-align: right; margin-bottom: 20px;
        }
        .expense-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 10px 0; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%; }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--c-white); border-top: 1px solid #eee;
            display: flex; justify-content: space-around; padding: 10px 0; z-index: 999;
        }
        .nav-item { text-align: center; color: #999; font-size: 0.7rem; flex: 1; cursor: pointer; }
        .nav-item.active { color: var(--c-primary); font-weight: bold; }
        .nav-icon { display: block; font-size: 1.4rem; margin-bottom: 2px; }

        .view-section { display: none; opacity: 0; transition: opacity 0.3s; }
        .view-section.active { display: block; opacity: 1; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <h1>æ›¸å¯«å±±ãƒ»å·¡ç¦®å¸–</h1>
    <p>ä¸­åœ‹å››åœ‹ Ã— åœ“æ•™å¯º 8æ—¥ç´€è¡Œ</p>
</header>

<div class="container">

    <div id="view-itinerary" class="view-section active">
        <div class="card" style="background: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%); color: white; border:none; display:flex; align-items:center; justify-content:space-between;">
            <div>
                <div style="font-size:0.9rem; opacity:0.8;">12æœˆ / å²¡å±±ãƒ»å§¬è·¯</div>
                <div style="font-size:1.8rem; font-weight:bold;">9Â°C</div>
            </div>
            <div style="text-align:right;">
                <div style="font-size:2rem;">â˜ï¸</div>
                <div style="font-size:0.8rem;">é©åˆæ´‹è”¥å¼ç©¿æ­</div>
            </div>
        </div>
        <div id="itinerary-list"></div>
    </div>

    <div id="view-explore" class="view-section">
        <div class="category-scroll">
            <button class="pill-btn active" onclick="selectMainCat('play', this)">ç©æ¨‚</button>
            <button class="pill-btn" onclick="selectMainCat('food', this)">ç¾é£Ÿ</button>
            <button class="pill-btn" onclick="selectMainCat('health', this)">å¥åº·</button>
            <button class="pill-btn" onclick="selectMainCat('conv', this)">ä¾¿åˆ©</button>
        </div>
        <div class="sub-cats" id="sub-cats-container"></div>
        <div id="map"></div>
        <div id="places-results">
            <p style="text-align:center; color:#888; font-size:0.9rem; margin-top:20px;">
                æ­£åœ¨è¼‰å…¥åœ°åœ–...
            </p>
        </div>
    </div>

    <div id="view-wallet" class="view-section">
        <div class="total-box">
            <small>ç¸½æ”¯å‡º</small>
            <div style="font-size:2rem; font-weight:bold;">Â¥ <span id="total-val">0</span></div>
        </div>
        <div class="card">
            <h3>ğŸ–Šï¸ æ–°å¢è¨˜å¸³</h3>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <input type="text" id="input-item" placeholder="é …ç›®" style="flex:2;">
                <input type="number" id="input-cost" placeholder="é‡‘é¡" style="flex:1;">
            </div>
            <button class="btn" style="width:100%; margin-top:10px;" onclick="addExpense()">åŠ å…¥</button>
        </div>
        <div class="card" id="expense-list" style="min-height:100px;"></div>
    </div>

</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchView('itinerary', this)">
        <span class="nav-icon">ğŸ“…</span>è¡Œç¨‹
    </div>
    <div class="nav-item" onclick="switchView('explore', this)">
        <span class="nav-icon">ğŸ—ºï¸</span>æ¢ç´¢
    </div>
    <div class="nav-item" onclick="switchView('wallet', this)">
        <span class="nav-icon">ğŸ’°</span>è¨˜å¸³
    </div>
</nav>

<script>
    // --- è¡Œç¨‹è³‡æ–™ (æºè‡ªä¸Šå‚³çš„æª”æ¡ˆ) ---
    [cite_start]// [cite: 1, 2, 4]
    const itineraryData = [
        { day: "Day 1 (12/10)", title: "æŠµé”å²¡å±±", items: [
            {t:"11:40", c:"æŠµé”å²¡å±±æ©Ÿå ´ -> å·´å£«è‡³å²¡å±±ç«™"}, {t:"14:00", c:"é ˜JR Pass & åŠƒä½"}, {t:"15:00", c:"å¾Œæ¨‚åœ’é£¯åº— Check-in / é«˜å³¶å±‹"}
        ]},
        { day: "Day 2 (12/11)", title: "é‡‘åˆ€æ¯”ç¾…å®®", items: [
            {t:"08:52", c:"å²¡å±± -> ç´å¹³ (å—é¢¨è™Ÿ)"}, {t:"10:00", c:"é‡‘åˆ€æ¯”ç¾…å®® (å»ºè­°è¨ˆç¨‹è»Šè‡³ç¥æ¤¿)"}, {t:"12:30", c:"åˆé¤ï¼šçƒé¾éºµ"}, {t:"15:45", c:"å²¡å±±å¾Œæ¨‚åœ’"}
        ]},
        { day: "Day 3 (12/12)", title: "å§¬è·¯ãƒ»æ›¸å¯«å±±", items: [
            {t:"07:25", c:"å²¡å±± -> å§¬è·¯ (æ–°å¹¹ç·š)"}, {t:"08:10", c:"ç¥å§¬å·´å£«#10 -> æ›¸å¯«å±±çºœè»Š"}, {t:"09:00", c:"åœ“æ•™å¯º (æœ«ä»£æ­¦å£«å–æ™¯åœ°)"}, {t:"13:30", c:"å§¬è·¯åŸã€å¥½å¤åœ’"}
        ]},
        { day: "Day 4 (12/13)", title: "å€‰æ•· -> æ¾å±±", items: [
            {t:"09:16", c:"å²¡å±± -> å€‰æ•·ç¾è§€åœ°å€"}, {t:"13:11", c:"è¿”å›å²¡å±±å–è¡Œæ"}, {t:"14:35", c:"å²¡å±± -> æ¾å±± (äºˆè®šç·šç‰¹æ€¥)"}, {t:"17:30", c:"å¤§è¡—é“ Check-in"}
        ]},
        { day: "Day 5 (12/14)", title: "æ¾å±±åŸãƒ»é“å¾Œ", items: [
            {t:"10:30", c:"æ¾å±±åŸ (çºœè»Š)ã€ä»Šæ²»æ¯›å·¾"}, {t:"13:00", c:"åˆé¤ï¼šé¯›é­šé£¯"}, {t:"15:00", c:"é“å¾Œæº«æ³‰ Check-in"}, {t:"16:00", c:"å°‘çˆºæ©Ÿé—œé˜ã€æº«æ³‰æœ¬é¤¨"}
        ]},
        { day: "Day 6 (12/15)", title: "æ¸¡è¼ª -> å»£å³¶", items: [
            {t:"10:50", c:"é“å¾Œ -> æ¾å±±æ¸¯"}, {t:"14:15", c:"æ­ä¹˜ SEA PASEO æ¸¡è¼ª"}, {t:"16:57", c:"æŠµé”å»£å³¶æ¸¯ -> å¸‚å€"}
        ]},
        { day: "Day 7 (12/16)", title: "å®®å³¶ãƒ»å»£å³¶", items: [
            {t:"07:22", c:"å»£å³¶ -> å®®å³¶å£ -> æ¸¡è¼ª"}, {t:"08:30", c:"åš´å³¶ç¥ç¤¾ã€å¤§é³¥å±…"}, {t:"14:30", c:"åŸçˆ†åœ“é ‚ã€å»£å³¶åŸ"}, {t:"18:00", c:"å…«ä¸å € (å»£å³¶ç‡’)"}
        ]},
        { day: "Day 8 (12/17)", title: "è¿”ç¨‹", items: [
            {t:"07:15", c:"å»£å³¶ç«™ -> æ©Ÿå ´å·´å£«"}, {t:"11:15", c:"é£›æ©Ÿèµ·é£› -> 13:10 æŠµé”æ¡ƒåœ’"}
        ]}
    ];

    const categories = {
        play: { label: "ç©æ¨‚", subs: ["å…¬åœ’", "åšç‰©é¤¨", "ç¥ç¤¾", "è³¼ç‰©ä¸­å¿ƒ"] },
        food: { label: "ç¾é£Ÿ", subs: ["è¦ªå­é¤å»³", "ç‡’è‚‰", "å£½å¸", "æ‹‰éºµ", "å’–å•¡å»³"] },
        health: { label: "å¥åº·", subs: ["è—¥å¦åº—", "è¨ºæ‰€", "é†«é™¢", "å»æ‰€"] },
        conv: { label: "ä¾¿åˆ©", subs: ["ä¾¿åˆ©å•†åº—", "è¶…å¸‚", "è»Šç«™", "åœè»Šå ´"] }
    };

    let map;
    let service;
    let infowindow;
    let markers = [];
    let expenses = [];
    try { expenses = JSON.parse(localStorage.getItem('tripExp')) || []; } catch(e){ expenses=[]; }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        renderItinerary();
        renderExpenses();
        selectMainCat('play');
    });

    // åœ°åœ–åŠŸèƒ½
    function initMap() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    createMap({ lat: position.coords.latitude, lng: position.coords.longitude });
                },
                () => {
                    createMap({ lat: 34.6663, lng: 133.9185 }); // å²¡å±±
                }
            );
        } else {
            createMap({ lat: 34.6663, lng: 133.9185 });
        }
    }

    function createMap(centerPos) {
        const mapEl = document.getElementById("map");
        if(!mapEl) return;
        
        map = new google.maps.Map(mapEl, {
            center: centerPos,
            zoom: 15,
            disableDefaultUI: true,
            styles: [
                { "featureType": "landscape", "stylers": [{ "color": "#f5f5f5" }] },
                { "featureType": "poi", "stylers": [{ "visibility": "simplified" }] }
            ]
        });

        new google.maps.Marker({
            position: centerPos,
            map: map,
            title: "ç›®å‰ä½ç½®",
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 8,
                fillColor: "#4285F4",
                fillOpacity: 1,
                strokeWeight: 2,
                strokeColor: "white",
            }
        });

        service = new google.maps.places.PlacesService(map);
        infowindow = new google.maps.InfoWindow();
    }

    function searchNearby(query) {
        if (!service) return;
        
        const request = {
            location: map.getCenter(),
            radius: '1000',
            query: query,
            openNow: true
        };

        markers.forEach(m => m.setMap(null));
        markers = [];
        document.getElementById('places-results').innerHTML = '<p style="text-align:center;">æœå°‹ä¸­...</p>';

        service.textSearch(request, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                renderPlacesList(results, query);
                const bounds = new google.maps.LatLngBounds();
                results.forEach(place => {
                    createMarker(place);
                    if (place.geometry.viewport) bounds.union(place.geometry.viewport);
                    else bounds.extend(place.geometry.location);
                });
                map.fitBounds(bounds);
            } else {
                document.getElementById('places-results').innerHTML = '<p style="text-align:center;">é™„è¿‘æ‰¾ä¸åˆ°ç‡Ÿæ¥­ä¸­çš„åœ°é»ã€‚</p>';
            }
        });
    }

    function createMarker(place) {
        const marker = new google.maps.Marker({
            map: map,
            position: place.geometry.location
        });
        google.maps.event.addListener(marker, "click", () => {
            infowindow.setContent(`<strong>${place.name}</strong><br>${place.formatted_address}`);
            infowindow.open(map, marker);
        });
        markers.push(marker);
    }

    function generateAiTip(place, query) {
        const types = place.types ? place.types.join(' ') : '';
        if (query.includes("ç‡’è‚‰") || types.includes("bbq")) return "æ³¨æ„ç‚­ç«ä½ç½®ï¼Œé¿å…å­©å­ç‡™å‚·ã€‚";
        if (query.includes("å±…é…’å±‹") || types.includes("bar")) return "ç¢ºèªæ˜¯å¦æœ‰ç¦è¸å€ã€‚";
        if (types.includes("park")) return "åˆ¥å¿˜äº†é˜²èšŠæ¶²ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰å…¬å»ã€‚";
        if (query.includes("ç¥ç¤¾") || query.includes("å¯º")) return "éšæ¢¯å¯èƒ½è¼ƒå¤šï¼Œè‹¥æœ‰æ¨è»Šå»ºè­°å¯„æ”¾ã€‚";
        if (types.includes("pharmacy")) return "å¯åœ¨æ­¤è³¼è²·å…’ç«¥é€€ç†±è²¼ã€‚";
        if (types.includes("convenience")) return "å¯è£œçµ¦ç‰›å¥¶ã€é£¯ç³°ã€‚";
        return "äººæ½®æ“æ“ æ™‚è«‹ç‰½å¥½å­©å­çš„æ‰‹ã€‚";
    }

    function renderPlacesList(results, query) {
        const container = document.getElementById('places-results');
        container.innerHTML = '';
        results.slice(0, 10).forEach(place => {
            const tip = generateAiTip(place, query);
            container.innerHTML += `
                <div class="place-card" onclick="panToPlace('${place.place_id}')">
                    <div style="font-weight:bold;">${place.name}</div>
                    <div style="font-size:0.8rem; color:#666; margin:4px 0;">â­ ${place.rating || '-'}</div>
                    <div class="ai-tip">çˆ¸åª½ Noteï¼š${tip}</div>
                </div>
            `;
        });
    }

    // å°‡å‡½å¼æ›è¼‰åˆ° windowï¼Œé¿å…ä½œç”¨åŸŸéŒ¯èª¤
    window.panToPlace = function(placeId) {
        const request = { placeId: placeId, fields: ['name', 'geometry'] };
        service.getDetails(request, (place, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                map.setCenter(place.geometry.location);
                map.setZoom(17);
            }
        });
    };

    window.selectMainCat = function(key, btn) {
        if(btn) {
            document.querySelectorAll('.category-scroll .pill-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        const subContainer = document.getElementById('sub-cats-container');
        subContainer.innerHTML = categories[key].subs.map(sub => 
            `<div class="sub-pill" onclick="searchNearby('${sub}')">${sub}</div>`
        ).join('');
        if(map) searchNearby(categories[key].subs[0]);
    };

    window.switchView = function(viewName, navEl) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${viewName}`).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        navEl.classList.add('active');
        if(viewName === 'explore' && map) setTimeout(() => google.maps.event.trigger(map, "resize"), 100);
    };

    function renderItinerary() {
        const list = document.getElementById('itinerary-list');
        list.innerHTML = itineraryData.map((day, idx) => `
            <div class="card">
                <div class="day-header" onclick="toggleDay(${idx})">
                    <b>${day.day} ${day.title}</b> <span>â–¼</span>
                </div>
                <div class="day-details ${idx===0?'open':''}" id="day-${idx}">
                    ${day.items.map(item => `
                        <div class="timeline-item">
                            <span class="time-badge">${item.t}</span> ${item.c}
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    window.toggleDay = function(idx) {
        document.getElementById(`day-${idx}`).classList.toggle('open');
    };

    function renderExpenses() {
        const list = document.getElementById('expense-list');
        let total = 0;
        list.innerHTML = expenses.map((ex, idx) => {
            total += parseInt(ex.cost);
            return `
                <div class="expense-item">
                    <span>${ex.item}</span>
                    <span>Â¥${Number(ex.cost).toLocaleString()} <span onclick="delExpense(${idx})" style="color:red; margin-left:8px; cursor:pointer;">Ã—</span></span>
                </div>
            `;
        }).join('');
        document.getElementById('total-val').innerText = total.toLocaleString();
    }
    
    window.addExpense = function() {
        const item = document.getElementById('input-item').value;
        const cost = document.getElementById('input-cost').value;
        if(item && cost) {
            expenses.push({item, cost});
            localStorage.setItem('tripExp', JSON.stringify(expenses));
            renderExpenses();
            document.getElementById('input-item').value = '';
            document.getElementById('input-cost').value = '';
        }
    };
    
    window.delExpense = function(idx) {
        expenses.splice(idx, 1);
        localStorage.setItem('tripExp', JSON.stringify(expenses));
        renderExpenses();
    };
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARy8kyAOrvlptzGYKaqR04QrZIxEUt6KI&libraries=places&callback=initMap"></script>

</body>
</html>
